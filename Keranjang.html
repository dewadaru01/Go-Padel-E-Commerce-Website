<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang Belanja - GoPadel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="Images/favicon-32x32.png">
</head>
<body class="antialiased text-gray-800 bg-gray-100">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-black">
                Go<span class="text-padel">Padel</span>
            </a>
            <nav class="hidden md:flex space-x-8 font-semibold">
                <a href="index.html#produk-unggulan" class="hover:text-padel transition duration-200">Produk Unggulan</a>
                <a href="index.html#promo" class="hover:text-padel transition duration-200">Promo</a>
                <a href="index.html#testimoni" class="hover:text-padel transition duration-200">Review</a>
            </nav>
            <div class="flex items-center space-x-4">
               <a href="Keranjang.html" class="relative text-gray-600 hover:text-padel transition duration-200" aria-label="Keranjang Belanja">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l3 11h11l3-11H3zM9 21a1 1 0 100-2 1 1 0 000 2zM15 21a1 1 0 100-2 1 1 0 000 2z" />
    </svg>
    <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">
        0
    </span>
</a>
            </div>
        </div>
    </header>

    <main class="py-12 md:py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl sm:text-4xl font-black text-center mb-10">Keranjang Belanja Anda</h1>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-2/3">
                    <div id="daftar-item-keranjang" class="bg-white p-6 rounded-xl shadow-lg space-y-6"></div>
                    <a href="index.html#produk-unggulan" class="inline-block mt-6 text-padel font-semibold hover:underline">&larr; Kembali Berbelanja</a>
                </div>
                <div class="w-full lg:w-1/3">
                    <div class="bg-white p-6 rounded-xl shadow-lg sticky top-28">
                        <h2 class="text-2xl font-bold border-b pb-4 mb-4">Ringkasan Pesanan</h2>
                        <div class="space-y-3 text-gray-700">
                            <div class="flex justify-between"><span id="jumlah-item">Subtotal (0 item)</span><span id="subtotal-harga" class="font-semibold">Rp 0</span></div>
                            <div class="flex justify-between"><span id="label-pengiriman">Biaya Pengiriman</span><span id="biaya-pengiriman" class="font-semibold">Rp 0</span></div>
                            <div id="baris-diskon" class="flex justify-between text-green-600 hidden"><span>Diskon Voucher</span><span id="jumlah-diskon" class="font-semibold">- Rp 0</span></div>
                            <div class="pt-4 border-t"><div class="flex justify-between items-center text-gray-900"><span class="text-xl font-bold">Total</span><span id="total-harga" class="text-2xl font-extrabold text-padel">Rp 0</span></div></div>
                        </div>
                        <div class="mt-6">
                            <p class="text-sm font-semibold mb-2">Punya Kode Voucher?</p>
                            <div class="flex gap-2">
                                <input id="input-voucher" type="text" placeholder="PADELNEWBIE" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400">
                                <button id="tombol-voucher" class="bg-gray-800 text-white font-bold px-4 rounded-md hover:bg-black">Gunakan</button>
                            </div>
                        </div>
                        <button class="w-full color-padel cta-button text-gray-900 font-bold py-3 rounded-full mt-6" onclick="goToCheckout()">Lanjutkan ke Pembayaran</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-gray-800 text-white py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="mb-6">
                <h4 class="font-bold text-lg mb-2 text-gray-300">Kelompok GoPadel</h4>
                <div class="text-gray-400 text-sm space-y-1">
                    <p>Natasya Cahya Salsabila (2322477221)</p>
                    <p>Diva Syabina Putri (2311477320)</p>
                    <p>Naila Salsabila Haerumanda (2314476963)</p>
                    <p>Alif Rifqi Dewadaru (2322476771)</p>
                </div>
            </div>
            <p class="text-gray-500 text-xs pt-6 border-t border-gray-700">&copy; 2025 GoPadel. Dibuat dengan semangat Padel.</p>
        </div>
    </footer>

    <div id="toast-notification"></div>

   <script>
    // Fungsi untuk update badge keranjang
    function updateCartBadge() {
        const keranjang = JSON.parse(localStorage.getItem('keranjang')) || [];
        let totalItem = 0;
        keranjang.forEach(item => { totalItem += item.kuantitas; });
        const badge = document.getElementById('cart-badge');
        if (badge) {
            if (totalItem > 0) { badge.textContent = totalItem; badge.classList.remove('hidden'); }
            else { badge.textContent = '0'; badge.classList.add('hidden'); }
        }
    }
    const itemContainer = document.getElementById('daftar-item-keranjang');
    const jumlahItemEl = document.getElementById('jumlah-item');
    const subtotalHargaEl = document.getElementById('subtotal-harga');
    const biayaPengirimanEl = document.getElementById('biaya-pengiriman');
    const totalHargaEl = document.getElementById('total-harga');
    let keranjang = JSON.parse(localStorage.getItem('keranjang')) || [];
    const VOUCHERS = { "PADELNEWBIE": 0.1, "GOPADEL15": 0.15 };
    let kodeVoucherAktif = localStorage.getItem('voucher') || null;
    let produkDatabase = [];

    function showToast(message) {
        const toast = document.getElementById("toast-notification");
        toast.textContent = message;
        toast.className = "show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }
    const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);

    function gunakanVoucher() {
        const inputVoucher = document.getElementById('input-voucher');
        const kode = inputVoucher.value.toUpperCase();
        if (VOUCHERS[kode]) {
            kodeVoucherAktif = kode;
            localStorage.setItem('voucher', kode);
            showToast(`Voucher "${kode}" berhasil digunakan!`);
            tampilkanKeranjang(); // Ini akan memanggil updateCartBadge()
        } else {
            showToast("Kode voucher tidak valid!");
        }
    }

    function updateKuantitas(idProduk, inputElement) {
        let kuantitasBaru = parseInt(inputElement.value);
        if (kuantitasBaru < 1 || isNaN(kuantitasBaru)) { kuantitasBaru = 1; inputElement.value = 1; }
        const itemDiKeranjang = keranjang.find(item => item.id === idProduk);
        if (itemDiKeranjang) { itemDiKeranjang.kuantitas = kuantitasBaru; }
        localStorage.setItem('keranjang', JSON.stringify(keranjang));
        tampilkanKeranjang(); // Ini akan memanggil updateCartBadge()
    }

    function hapusItem(idProduk) {
        keranjang = keranjang.filter(item => item.id !== idProduk);
        localStorage.setItem('keranjang', JSON.stringify(keranjang));
        tampilkanKeranjang(); // Ini akan memanggil updateCartBadge()
    }

    function tampilkanKeranjang() {
        const keranjangAsli = keranjang.length;
        keranjang = keranjang.filter(item => produkDatabase.some(p => p.id === item.id));
        if (keranjang.length !== keranjangAsli) {
            localStorage.setItem('keranjang', JSON.stringify(keranjang));
        }
        itemContainer.innerHTML = '';
        let subtotal = 0;
        let totalItem = 0;
        if (keranjang.length === 0) {
            itemContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Keranjang belanja Anda kosong.</p>';
            biayaPengirimanEl.textContent = formatRupiah(0);
            kodeVoucherAktif = null;
            localStorage.removeItem('voucher');
        } else {
            keranjang.forEach(item => {
                const produkDetail = produkDatabase.find(p => p.id === item.id);
                if (produkDetail) {
                    const hargaItemTotal = produkDetail.harga * item.kuantitas;
                    subtotal += hargaItemTotal;
                    totalItem += item.kuantitas;
                    const itemHTML = `<div class="flex flex-col sm:flex-row items-center gap-4 border-b pb-4 last:border-b-0 last:pb-0"><img src="${produkDetail.gambar}" alt="${produkDetail.nama}" class="w-24 h-auto rounded-lg"><div class="flex-grow text-center sm:text-left"><h3 class="text-lg font-bold">${produkDetail.nama}</h3></div><div class="flex items-center gap-3"><input type="number" value="${item.kuantitas}" class="w-14 text-center border rounded-md p-1" min="1" onchange="updateKuantitas('${item.id}', this)"></div><div class="text-center"><p class="text-lg font-bold">${formatRupiah(hargaItemTotal)}</p><button onclick="hapusItem('${item.id}')" class="text-xs text-red-500 hover:underline mt-1">Hapus</button></div></div>`;
                    itemContainer.innerHTML += itemHTML;
                }
            });
        }
        let nilaiDiskon = 0;
        if (kodeVoucherAktif && VOUCHERS[kodeVoucherAktif] && subtotal > 0) {
            nilaiDiskon = subtotal * VOUCHERS[kodeVoucherAktif];
            document.getElementById('jumlah-diskon').textContent = `- ${formatRupiah(nilaiDiskon)}`;
            document.getElementById('baris-diskon').classList.remove('hidden');
        } else {
            document.getElementById('baris-diskon').classList.add('hidden');
        }
        const labelPengirimanEl = document.getElementById('label-pengiriman');
        const biayaPengiriman = (subtotal >= 500000 || keranjang.length === 0) ? 0 : 25000;
        if (biayaPengiriman === 0 && keranjang.length > 0) {
            if(labelPengirimanEl) labelPengirimanEl.textContent = 'Pengiriman (Gratis!)';
            biayaPengirimanEl.classList.add('text-green-600');
        } else {
            if(labelPengirimanEl) labelPengirimanEl.textContent = 'Biaya Pengiriman';
            biayaPengirimanEl.classList.remove('text-green-600');
        }
        const totalKeseluruhan = subtotal + biayaPengiriman - nilaiDiskon;
        jumlahItemEl.textContent = `Subtotal (${totalItem} item)`;
        subtotalHargaEl.textContent = formatRupiah(subtotal);
        biayaPengirimanEl.textContent = formatRupiah(biayaPengiriman);
        totalHargaEl.textContent = formatRupiah(totalKeseluruhan < 0 ? 0 : totalKeseluruhan);
        
        updateCartBadge(); // <-- Panggil di akhir setelah semua kalkulasi
    }

    function goToCheckout() {
        if (keranjang.length === 0) {
            showToast('Keranjang Anda kosong. Silakan belanja terlebih dahulu.');
            return;
        }
        window.location.href = 'checkout.html';
    }

    document.addEventListener("DOMContentLoaded", function() {
        updateCartBadge(); // <-- Panggil saat DOM siap
        const apiUrl = 'http://localhost:3000/api/produk';
        fetch(apiUrl)
            .then(response => response.json())
            .then(semuaProduk => {
                produkDatabase = semuaProduk;
                tampilkanKeranjang(); // Ini akan memanggil updateCartBadge() lagi
                document.getElementById('tombol-voucher').addEventListener('click', gunakanVoucher);
            })
            .catch(error => {
                console.error('Gagal memuat data produk:', error);
                itemContainer.innerHTML = '<p class="text-red-500 text-center">Gagal memuat detail produk. Server berjalan?</p>';
                updateCartBadge(); // Panggil agar badge tetap 0 jika error
            });
    });
</script>
</body>
</html>